# 可意AI心理医生 - 第二版（V2）任务规划

> 基于《高级工作流手册》拆解的完整开发计划
>
> **版本**: V2.0
> **创建日期**: 2026-02-13
> **优先级**: P1

---

## 一、项目愿景

在 V1 MVP 基础上，实现**用户账户体系**、**增强情绪识别**、**对话历史持久化**，让用户拥有专属的 AI 心理陪伴记忆。

**核心目标**：
- 用户数据安全存储
- 个性化心理陪伴
- 长期情绪追踪
- 更温暖、更懂用户的 AI

---

## 二、功能模块总览

| 模块 | 功能点 | 优先级 | 预估工作量 |
|------|--------|--------|------------|
| **用户系统** | 邮箱登录/注册 | P0 | 3天 |
| | 匿名用户数据迁移 | P0 | 2天 |
| | 用户设置页面 | P1 | 1天 |
| **对话系统** | 对话历史存储 | P0 | 2天 |
| | 历史摘要提取 | P1 | 2天 |
| | 上下文注入 | P1 | 1天 |
| **情绪系统** | 多维情绪识别 | P0 | 3天 |
| | 情绪趋势分析 | P1 | 2天 |
| | PEERE模型应用 | P1 | 2天 |
| **互动功能** | 用户画像构建 | P1 | 2天 |
| | 个性化关怀 | P2 | 2天 |
| **安全系统** | 数据导出/删除 | P1 | 1天 |

---

## 三、详细任务拆解

### 模块一：用户系统（总：6天）

#### TASK_001: Supabase 邮箱登录/注册

**描述**: 实现基于 Supabase Auth 的邮箱登录注册功能

**验收标准**:
- [ ] 用户可以使用邮箱注册账户
- [ ] 用户可以登录已有账户
- [ ] 登录状态持久化（7天免登录）
- [ ] 登录后自动创建用户配置

**子任务**:
- [ ] 创建用户表 `users`（id、email、nickname、created_at、updated_at）
- [ ] 配置 Supabase Auth（邮箱验证、可选密码）
- [ ] 创建前端登录页面 `/login`
- [ ] 创建前端注册页面 `/register`
- [ ] 实现 AuthContext（登录状态管理）
- [ ] 添加路由保护（未登录跳转登录页）
- [ ] 添加忘记密码功能

**技术要点**:
```
Supabase: auth.users + custom user profile table
前端: AuthContext + React Router protection
```

---

#### TASK_002: 匿名用户数据迁移

**描述**: 将匿名用户的对话数据迁移到注册账户

**验收标准**:
- [ ] 匿名会话可导出
- [ ] 注册后可选导入历史数据
- [ ] 数据合并策略（冲突时保留用户选择）
- [ ] 迁移过程平滑无丢失

**子任务**:
- [ ] 创建数据导出API（返回JSON）
- [ ] 创建数据导入API（解析JSON并存储）
- [ ] 前端添加导入引导弹窗
- [ ] 设计数据合并UI

---

#### TASK_003: 用户设置页面

**描述**: 用户管理个人信息和偏好

**验收标准**:
- [ ] 编辑昵称
- [ ] 设置头像（可选）
- [ ] 设置咨询偏好（称呼方式、主题等）
- [ ] 数据管理（导出、删除账户）

**子任务**:
- [ ] 创建设置页面 `/settings`
- [ ] 实现昵称更新API
- [ ] 实现头像上传（可选，Supabase Storage）
- [ ] 实现数据导出/删除API

---

### 模块二：对话系统（总：6天）

#### TASK_004: Supabase 对话历史存储

**描述**: 将对话保存到 Supabase 数据库

**验收标准**:
- [ ] 每条消息保存到数据库
- [ ] 支持查询历史对话
- [ ] 按时间分页加载
- [ ] 会话列表展示

**数据库设计**:
```sql
-- 对话会话表
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  title TEXT,                    -- 对话标题（首句摘要）
  started_at TIMESTAMPTZ DEFAULT NOW(),
  last_message_at TIMESTAMPTZ,
  status TEXT DEFAULT 'active',  -- active/archived
  metadata JSONB DEFAULT '{}'    -- 额外信息
);

-- 对话消息表
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
  role TEXT CHECK (role IN ('user', 'assistant')),
  content TEXT NOT NULL,
  emotion JSONB,                -- 情绪分析结果
  tokens INT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**子任务**:
- [ ] 创建 migrations 脚本（Vercel SQL Runner 执行）
- [ ] 更新 `api/index.js` 集成 Supabase
- [ ] 创建 `getConversations` API
- [ ] 创建 `getMessages(conversationId)` API
- [ ] 创建 `saveMessage` API
- [ ] 创建 `createConversation` API
- [ ] 前端对话列表页面 `/conversations`

---

#### TASK_005: 对话摘要自动生成

**描述**: 从长对话中提取摘要，用于会话列表展示

**验收标准**:
- [ ] 对话结束后自动生成标题
- [ ] 标题准确反映对话主题
- [ ] 支持手动编辑标题

**子任务**:
- [ ] 实现 LLM 摘要生成函数
- [ ] 对话超过N条后触发摘要
- [ ] 前端支持编辑标题

**提示词**:
```
根据以下对话，生成一个10字以内的标题，准确概括对话主题：

用户：[用户首句]
AI：[AI首句]
...

标题：
```

---

#### TASK_006: 上下文注入

**描述**: 让 AI 能"记住"用户的历史信息

**验收标准**:
- [ ] 新对话时加载用户画像摘要
- [ ] 对话中可查询历史相关信息
- [ ] 用户信息自动更新

**实现方案**:
```javascript
// 每次对话前注入
const context = await getUserContext(userId);
// 格式：
// === 用户档案 ===
// 姓名：XXX
// 历史主题：[情绪低落, 工作压力, 人际关系]
// 上次对话提到：XXX
// ===

const messages = [
  { role: "system", content: SYSTEM_PROMPT + context },
  ...historyMessages
];
```

**子任务**:
- [ ] 创建用户画像表 `user_profiles`
- [ ] 实现画像更新逻辑（从对话提取）
- [ ] 实现画像查询 API
- [ ] 更新 LLM 调用注入上下文

---

### 模块三：情绪系统（总：7天）

#### TASK_007: 多维情绪识别

**描述**: 实现 PEERE 模型的情绪识别增强

**验收标准**:
- [ ] 识别 6 种基本情绪
- [ ] 识别 5 种复合情绪（焦虑、抑郁、孤独、内疚、愤怒）
- [ ] 情绪强度分级（轻微/中等/强烈）
- [ ] 情绪原因推断

**PEERE 模型输出格式**:
```json
{
  "primary_emotion": "anxiety",
  "intensity": "medium",
  "confidence": 0.85,
  "emotion_label": "焦虑",
  "cause_hint": "可能与工作压力相关",
  "peere": {
    "paraphrase": "听起来你对即将到来的汇报很担心...",
    "emotion": "我能感受到你的焦虑...",
    "example": "比如担心汇报时表现不好...",
    "respect": "你愿意说出来很勇敢...",
    "support": "我会陪你一起..."
  }
}
```

**子任务**:
- [ ] 更新 LLM prompt 支持 PEERE 输出
- [ ] 解析 PEERE 结构化响应
- [ ] 更新前端情绪展示组件
- [ ] 情绪数据存入消息表

---

#### TASK_008: 情绪趋势分析

**描述**: 根据历史数据生成情绪趋势图

**验收标准**:
- [ ] 日/周/月情绪统计
- [ ] 情绪热力图
- [ ] 主要情绪分布饼图
- [ ] 趋势解读文案

**子任务**:
- [ ] 创建情绪统计 API（聚合查询）
- [ ] 前端图表组件（使用 recharts）
- [ ] 实现数据解读文案生成
- [ ] 趋势页面 `/trends`

**图表设计**:
- 折线图：情绪强度变化
- 柱状图：各情绪出现频率
- 饼图：情绪分布占比

---

### 模块四：互动功能（总：4天）

#### TASK_009: 用户画像自动构建

**描述**: 从对话中自动提取和维护用户画像

**验收标准**:
- [ ] 识别用户关注主题
- [ ] 记录用户偏好（称呼、沟通风格）
- [ ] 追踪个人关键词（人名、事件、地点）
- [ ] 画像持久化存储

**画像数据结构**:
```json
{
  "user_id": "xxx",
  "nickname": "用户昵称",
  "preferred_name": "用户喜欢的称呼",
  "topics": ["工作压力", "家庭关系", "睡眠问题"],
  "key_info": {
    "公司": "XX公司",
    "同事": "张三",
    "重要日期": "2026-02-14"
  },
  "communication_style": {
    "偏好": "直接",
    "敏感话题": ["收入", "感情"]
  },
  "last_updated": "2026-02-13T10:00:00Z"
}
```

**子任务**:
- [ ] 实现画像提取 LLM prompt
- [ ] 对话结束后触发画像更新
- [ ] 创建画像查询/更新 API
- [ ] 前端展示用户画像

---

#### TASK_010: 个性化关怀（可选 V2.1）

**描述**: 基于用户画像提供个性化回应

**验收标准**:
- [ ] 使用用户喜欢的称呼
- [ ] 主动提及上次话题
- [ ] 纪念日/重要日期提醒
- [ ] 情绪低落时主动关怀

**实现示例**:
```
用户上次提到2月14日有重要面试，
今天2月14日，AI主动问候：
"今天是你说的大日子，祝你面试顺利！
还记得你之前准备的自我介绍吗？需要我再帮你看看吗？"
```

**子任务**:
- [ ] 实现纪念日检测
- [ ] 实现"上次提到"查询
- [ ] 创建个性化回复生成
- [ ] 前端添加关怀动画

---

### 模块五：安全与合规（总：1天）

#### TASK_011: 数据导出与删除

**描述**: 符合隐私法规的数据管理

**验收标准**:
- [ ] 一键导出所有个人数据（JSON）
- [ ] 一键删除账户（不可恢复）
- [ ] 删除确认与冷静期

**子任务**:
- [ ] 实现数据导出 API（聚合所有表）
- [ ] 实现账户删除 API（含 RLS 策略）
- [ ] 前端添加导出/删除按钮
- [ ] 添加安全提示

---

## 四、技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端 (Vite + React)                     │
├─────────────────────────────────────────────────────────────┤
│  /login          - 登录页面                                 │
│  /register       - 注册页面                                 │
│  /conversations  - 对话列表                                 │
│  /chat/:id       - 对话详情                                 │
│  /trends         - 情绪趋势                                  │
│  /settings       - 用户设置                                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Vercel API (index.js)                    │
├─────────────────────────────────────────────────────────────┤
│  POST   /api/auth/*      - 认证相关                          │
│  POST   /api/conversation - 会话管理                          │
│  POST   /api/message      - 消息处理                          │
│  GET    /api/messages     - 消息查询                          │
│  POST   /api/emotion      - 情绪分析                          │
│  GET    /api/profile      - 用户画像                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Supabase                                 │
├─────────────────────────────────────────────────────────────┤
│  auth.users        - 认证用户                               │
│  profiles          - 用户配置                                │
│  conversations     - 对话会话                                │
│  messages         - 消息记录                                │
│  user_profiles    - 用户画像                                │
│  emotions         - 情绪记录                                │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、依赖关系

```
TASK_001 (登录注册)
    │
    ▼
TASK_002 (数据迁移) ←── 可独立
    │
    ▼
TASK_003 (用户设置)
    │
    ▼
TASK_004 (对话存储)
    │
    ▼
TASK_005 (摘要生成) ──┬──→ TASK_006 (上下文注入)
    │                  │
    ▼                  ▼
TASK_007 (情绪识别) ──┴──→ TASK_008 (情绪趋势)
    │
    ▼
TASK_009 (用户画像)
    │
    ▼
TASK_010 (个性化关怀) [V2.1]
    │
    ▼
TASK_011 (数据管理)
```

---

## 六、里程碑

| 里程碑 | 目标 | 时间 |
|--------|------|------|
| M1 | 用户系统上线 | 第1周 |
| M2 | 对话历史功能 | 第2周 |
| M3 | 情绪系统增强 | 第3周 |
| M4 | 完整 V2 发布 | 第4周 |

---

## 七、验收测试清单

### 功能测试
- [ ] 用户注册/登录流程
- [ ] 匿名数据迁移
- [ ] 对话创建/发送/历史
- [ ] 情绪识别准确率
- [ ] 用户画像更新

### 性能测试
- [ ] API 响应时间 < 1s
- [ ] 情绪分析 < 2s
- [ ] 支持 100 并发用户

### 安全测试
- [ ] 未登录无法访问数据
- [ ] 用户只能看自己的数据
- [ ] 导出/删除功能正常

---

## 八、风险与应对

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| Supabase 配额不足 | 低 | 高 | 监控用量，设置告警 |
| LLM API 成本超支 | 中 | 中 | 限制调用频率，优化 prompt |
| 用户画像质量差 | 中 | 低 | 人工审核，持续优化 |
| 隐私合规风险 | 低 | 高 | 遵循《个人信息保护法》 |

---

## 九、参考文档

- [高级工作流手册](../docs/高级工作流手册.md)
- [Supabase 文档](https://supabase.com/docs)
- [Vercel 部署指南](https://vercel.com/docs)

---

**创建人**: Claude
**最后更新**: 2026-02-13
**状态**: 待评审
