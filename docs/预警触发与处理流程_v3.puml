@startuml AI心理医生MVP预警触发与处理流程_v3

skinparam backgroundColor #FEFEFE
skinparam handwritten false
skinparam shadowing false
skinparam defaultFontName "Microsoft YaHei"

title AI心理医生MVP预警触发与处理流程 (第三版)

skinparam participant {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #0D47A1
}
skinparam database {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
    FontColor #E65100
}

actor "用户" as User
participant "前端界面" as Frontend
participant "预警服务" as AlertService
participant "通知服务" as NotificationService
participant "异步任务队列" as AsyncTaskQueue
participant "用户服务" as UserService
database "数据库\n(PostgreSQL)" as Database
database "缓存\n(Redis)" as Cache

== 实时监控流程 ==

AlertService -> AlertService: 实时监控对话内容
AlertService -> AlertService: 实时监控情绪状态
AlertService -> AlertService: 实时监控评估结果
AlertService -> AlertService: 检测风险信号

== 风险检测流程 ==

AlertService -> AlertService: 匹配高危关键词
loop 遍历高危关键词列表
    AlertService -> AlertService: 检查关键词匹配
end

AlertService -> AlertService: 匹配绝望关键词
loop 遍历绝望关键词列表
    AlertService -> AlertService: 检查关键词匹配
end

AlertService -> AlertService: 检查情绪指标
AlertService -> AlertService: 检查评估指标

== 预警级别判断流程 ==

alt 检测到一级预警(紧急)
    note right: 触发条件:\n- 明确表达自杀或自伤意图\n- 提及"自杀"、"结束生命"等
    
    AlertService -> Database: 记录预警事件
    Database --> AlertService: 记录成功
    AlertService -> Database: 更新用户风险等级为"紧急"
    Database --> AlertService: 更新成功
    AlertService -> Cache: 缓存预警状态\n(TTL: 24小时)
    
    AlertService -> NotificationService: 触发紧急通知
    NotificationService -> AsyncTaskQueue: 发送短信\n(优先级: 高)
    NotificationService -> AsyncTaskQueue: 发送邮件\n(优先级: 高)
    
    AsyncTaskQueue -> NotificationService: 短信发送成功
    AsyncTaskQueue -> NotificationService: 邮件发送成功
    NotificationService --> AlertService: 通知发送成功
    
    AlertService -> Frontend: 立即中断对话
    Frontend -> User: 展示紧急资源
    Frontend -> User: 显示危机热线\n(400-161-9995)
    Frontend -> User: 显示紧急电话\n(110/120)
    Frontend -> User: 推荐就近精神卫生中心
    Frontend -> User: 鼓励立即寻求专业帮助
    
    AlertService -> AlertService: 启动定期跟进\n(每4小时一次)
    AlertService -> Database: 记录跟进计划
    Database --> AlertService: 记录成功

else 检测到二级预警(高危)
    note right: 触发条件:\n- 表达绝望、无望\n- PHQ-9得分≥15或GAD-7得分≥15
    
    AlertService -> Database: 记录预警事件
    Database --> AlertService: 记录成功
    AlertService -> Database: 更新用户风险等级为"高危"
    Database --> AlertService: 更新成功
    AlertService -> Cache: 缓存预警状态\n(TTL: 24小时)
    
    AlertService -> NotificationService: 发送通知
    NotificationService -> AsyncTaskQueue: 发送短信\n(优先级: 中)
    NotificationService -> AsyncTaskQueue: 发送邮件\n(优先级: 中)
    
    AsyncTaskQueue -> NotificationService: 发送成功
    NotificationService --> AlertService: 通知发送成功
    
    AlertService -> Frontend: 插入预警提示
    Frontend -> User: 提供危机热线\n(400-161-9995)
    Frontend -> User: 建议寻求专业帮助
    Frontend -> User: 显示各地精神卫生中心链接
    
    AlertService -> AlertService: 启动定期跟进\n(每12小时一次)
    AlertService -> Database: 记录跟进计划
    Database --> AlertService: 记录成功

else 检测到三级预警(关注)
    note right: 触发条件:\n- 情绪持续低落\n- 评估结果中重度\n- 多次评估结果恶化
    
    AlertService -> Database: 记录预警事件
    Database --> AlertService: 记录成功
    AlertService -> Database: 更新用户风险等级为"关注"
    Database --> AlertService: 更新成功
    AlertService -> Cache: 缓存预警状态\n(TTL: 24小时)
    
    AlertService -> Frontend: 对话结束后展示
    Frontend -> User: 提供心理支持
    Frontend -> User: 建议进行心理评估
    Frontend -> User: 推荐应对建议
    
    AlertService -> AlertService: 启动定期回访\n(每24小时一次)
    AlertService -> Database: 记录回访计划
    Database --> AlertService: 记录成功

else 无风险
    AlertService -> Database: 记录正常状态
    Database --> AlertService: 记录成功
    AlertService -> Cache: 缓存正常状态\n(TTL: 1小时)
end

== 预警解除流程 ==

AlertService -> AlertService: 检查用户状态
AlertService -> Database: 查询最近对话记录
Database --> AlertService: 返回对话记录
AlertService -> Database: 查询最近评估结果
Database --> AlertService: 返回评估结果

alt 用户状态改善
    AlertService -> AlertService: 判断可以解除预警
    AlertService -> Database: 更新预警状态为"已解除"
    Database --> AlertService: 更新成功
    AlertService -> Database: 更新用户风险等级为"低"
    Database --> AlertService: 更新成功
    AlertService -> Cache: 清除预警缓存
    
    AlertService -> NotificationService: 发送解除通知
    NotificationService -> AsyncTaskQueue: 发送通知\n(优先级: 低)
    AsyncTaskQueue -> NotificationService: 发送成功
    NotificationService --> AlertService: 通知发送成功
    
    AlertService -> Database: 记录解除原因
    Database --> AlertService: 记录成功
end

== 预警升级流程 ==

AlertService -> AlertService: 持续监控用户状态
AlertService -> Database: 查询预警历史
Database --> AlertService: 返回预警历史

alt 风险等级提升
    AlertService -> AlertService: 判断需要升级预警
    AlertService -> Database: 更新预警级别
    Database --> AlertService: 更新成功
    AlertService -> Database: 更新用户风险等级
    Database --> AlertService: 更新成功
    AlertService -> Cache: 更新预警缓存
    
    AlertService -> NotificationService: 发送升级通知
    NotificationService -> AsyncTaskQueue: 发送紧急通知\n(优先级: 高)
    AsyncTaskQueue -> NotificationService: 发送成功
    NotificationService --> AlertService: 通知发送成功
    
    AlertService -> Database: 记录升级原因
    Database --> AlertService: 记录成功
    
    AlertService -> AlertService: 调整跟进频率\n(更频繁)
    AlertService -> Database: 更新跟进计划
    Database --> AlertService: 更新成功
end

== 定期跟进流程 ==

AlertService -> AlertService: 检查跟进计划
AlertService -> Database: 查询待跟进用户
Database --> AlertService: 返回待跟进列表

loop 遍历待跟进用户
    AlertService -> Database: 查询用户最近状态
    Database --> AlertService: 返回用户状态
    
    alt 用户状态未改善
        AlertService -> NotificationService: 发送关怀通知
        NotificationService -> AsyncTaskQueue: 发送通知
        AsyncTaskQueue -> NotificationService: 发送成功
        NotificationService --> AlertService: 通知发送成功
        
        AlertService -> Database: 记录跟进结果
        Database --> AlertService: 记录成功
    else 用户状态改善
        AlertService -> AlertService: 判断可以解除预警
        AlertService -> Database: 更新预警状态
        Database --> AlertService: 更新成功
        AlertService -> Database: 记录跟进结果
        Database --> AlertService: 记录成功
    end
end

== 异常处理流程 ==

alt 通知发送失败
    NotificationService -> AsyncTaskQueue: 重试发送\n(最多5次)
    alt 重试成功
        AsyncTaskQueue -> NotificationService: 发送成功
        NotificationService --> AlertService: 通知发送成功
    else 重试失败
        AsyncTaskQueue -> AlertService: 发送失败
        AlertService -> Database: 记录发送失败
        Database --> AlertService: 记录成功
        AlertService -> AlertService: 标记为待人工处理
    end
end

alt 数据库写入失败
    AlertService -> AsyncTaskQueue: 异步重试写入
    AsyncTaskQueue -> Database: 重试写入
    alt 重试成功
        AsyncTaskQueue -> AlertService: 写入成功
    else 重试失败
        AsyncTaskQueue -> AlertService: 写入失败
        AlertService -> AlertService: 记录到本地日志
    end
end

== 预警统计与分析流程 ==

AlertService -> Database: 查询预警统计数据
Database --> AlertService: 返回统计数据
AlertService -> AlertService: 生成预警分析报告
AlertService -> Database: 保存分析报告
Database --> AlertService: 保存成功

AlertService -> Database: 查询高频预警用户
Database --> AlertService: 返回用户列表
AlertService -> AlertService: 重点关注高频用户
AlertService -> Database: 更新用户关注等级
Database --> AlertService: 更新成功

@enduml
