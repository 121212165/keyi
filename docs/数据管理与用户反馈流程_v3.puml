@startuml AI心理医生MVP数据管理与用户反馈流程_v3

skinparam backgroundColor #FEFEFE
skinparam handwritten false
skinparam shadowing false
skinparam defaultFontName "Microsoft YaHei"

title AI心理医生MVP数据管理与用户反馈流程 (第三版)

skinparam participant {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #0D47A1
}
skinparam database {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
    FontColor #E65100
}

actor "用户" as User
participant "前端界面" as Frontend
participant "安全层" as Security
participant "API网关" as APIGateway
participant "用户服务" as UserService
participant "反馈服务" as FeedbackService
participant "异步任务队列" as AsyncTaskQueue
database "数据库\n(PostgreSQL)" as Database
database "缓存\n(Redis)" as Cache
database "对象存储\n(OSS)" as ObjectStorage

== 数据查看流程 ==

User -> Frontend: 进入个人中心
Frontend -> Security: 验证JWT Token
Security --> Frontend: 验证通过
Frontend -> User: 展示数据管理选项

User -> Frontend: 查看对话历史
Frontend -> APIGateway: 请求对话历史
APIGateway -> UserService: 获取对话历史
UserService -> Database: 查询对话记录
Database --> UserService: 返回对话记录
UserService -> UserService: 按时间排序
UserService -> UserService: 分页处理
UserService --> APIGateway: 返回对话历史
APIGateway --> Frontend: 返回对话历史
Frontend -> User: 展示对话历史列表

User -> Frontend: 查看对话详情
Frontend -> APIGateway: 请求对话详情
APIGateway -> UserService: 获取对话详情
UserService -> Database: 查询对话详情
Database --> UserService: 返回对话详情
UserService --> APIGateway: 返回对话详情
APIGateway --> Frontend: 返回对话详情
Frontend -> User: 展示对话详情

User -> Frontend: 查看评估报告
Frontend -> APIGateway: 请求评估报告
APIGateway -> UserService: 获取评估报告
UserService -> Database: 查询评估记录
Database --> UserService: 返回评估记录
UserService --> APIGateway: 返回评估报告
APIGateway --> Frontend: 返回评估报告
Frontend -> User: 展示评估报告列表

User -> Frontend: 查看情绪趋势
Frontend -> APIGateway: 请求情绪趋势
APIGateway -> UserService: 获取情绪趋势
UserService -> Database: 查询情绪记录
Database --> UserService: 返回情绪记录
UserService -> UserService: 生成趋势分析
UserService -> UserService: 生成趋势图表
UserService --> APIGateway: 返回情绪趋势
APIGateway --> Frontend: 返回情绪趋势
Frontend -> User: 展示情绪趋势图

== 数据删除流程 ==

User -> Frontend: 选择删除数据类型
Frontend -> User: 显示删除选项:\n- 对话记录\n- 评估报告\n- 全部数据

User -> Frontend: 选择删除对话记录
Frontend -> User: 显示删除范围:\n- 单条对话\n- 时间范围\n- 全部对话

User -> Frontend: 确认删除
Frontend -> User: 显示删除确认对话框
Frontend -> User: 显示删除后果提示
User -> Frontend: 确认删除

Frontend -> APIGateway: 请求删除对话
APIGateway -> UserService: 删除对话记录
UserService -> Database: 删除对话记录
Database --> UserService: 删除成功
UserService -> Database: 删除对话情绪记录
Database --> UserService: 删除成功
UserService -> Cache: 清除相关缓存
Cache --> UserService: 清除成功
UserService --> APIGateway: 返回删除成功
APIGateway --> Frontend: 返回删除成功
Frontend -> User: 提示删除成功
Frontend -> User: 更新对话历史列表

User -> Frontend: 选择删除评估报告
Frontend -> User: 显示删除范围:\n- 单个报告\n- 时间范围\n- 全部报告

User -> Frontend: 确认删除
Frontend -> APIGateway: 请求删除评估报告
APIGateway -> UserService: 删除评估报告
UserService -> Database: 删除评估记录
Database --> UserService: 删除成功
UserService -> Database: 删除评估答案
Database --> UserService: 删除成功
UserService -> Cache: 清除相关缓存
Cache --> UserService: 清除成功
UserService --> APIGateway: 返回删除成功
APIGateway --> Frontend: 返回删除成功
Frontend -> User: 提示删除成功
Frontend -> User: 更新评估报告列表

User -> Frontend: 选择删除全部数据
Frontend -> User: 显示严重警告
Frontend -> User: 显示删除后果:\n- 所有对话记录将被删除\n- 所有评估报告将被删除\n- 用户账户将被注销
Frontend -> User: 要求输入确认文字

User -> Frontend: 输入确认文字
Frontend -> Frontend: 验证确认文字
Frontend -> APIGateway: 请求删除全部数据
APIGateway -> UserService: 删除用户数据
UserService -> Database: 删除用户记录
Database --> UserService: 删除成功
UserService -> Database: 删除所有对话记录
Database --> UserService: 删除成功
UserService -> Database: 删除所有评估记录
Database --> UserService: 删除成功
UserService -> Database: 删除所有预警记录
Database --> UserService: 删除成功
UserService -> Cache: 清除所有用户缓存
Cache --> UserService: 清除成功
UserService -> ObjectStorage: 删除用户文件
ObjectStorage --> UserService: 删除成功
UserService --> APIGateway: 返回删除成功
APIGateway --> Frontend: 返回删除成功
Frontend -> Frontend: 清除本地缓存
Frontend -> Frontend: 清除本地Token
Frontend -> User: 提示删除成功
Frontend -> User: 返回欢迎页面

== 数据导出流程 ==

User -> Frontend: 选择导出数据
Frontend -> User: 显示导出选项:\n- 对话记录\n- 评估报告\n- 全部数据

User -> Frontend: 选择导出格式
Frontend -> User: 显示格式选项:\n- PDF\n- JSON\n- CSV

User -> Frontend: 确认导出
Frontend -> APIGateway: 请求导出数据
APIGateway -> AsyncTaskQueue: 创建导出任务
AsyncTaskQueue -> Database: 查询用户数据
Database --> AsyncTaskQueue: 返回用户数据
AsyncTaskQueue -> AsyncTaskQueue: 生成导出文件
AsyncTaskQueue -> ObjectStorage: 上传导出文件
ObjectStorage --> AsyncTaskQueue: 上传成功
AsyncTaskQueue -> Database: 保存导出记录
Database --> AsyncTaskQueue: 保存成功
AsyncTaskQueue -> AsyncTaskQueue: 生成下载链接
AsyncTaskQueue -> Database: 保存下载链接
Database --> AsyncTaskQueue: 保存成功
AsyncTaskQueue -> AsyncTaskQueue: 设置链接有效期(7天)
AsyncTaskQueue --> APIGateway: 返回任务完成
APIGateway --> Frontend: 返回下载链接
Frontend -> User: 展示下载链接
Frontend -> User: 提示链接有效期

User -> Frontend: 点击下载链接
Frontend -> ObjectStorage: 下载文件
ObjectStorage --> Frontend: 返回文件
Frontend -> User: 保存文件到本地

== 用户反馈流程 ==

User -> Frontend: 进入反馈页面
Frontend -> User: 展示反馈类型:\n- 功能建议\n- Bug反馈\n- 使用体验\n- 其他

User -> Frontend: 选择反馈类型
Frontend -> User: 展示反馈表单

User -> Frontend: 填写反馈内容
Frontend -> User: 输入反馈标题
Frontend -> User: 输入反馈详情
Frontend -> User: 上传截图(可选)
Frontend -> User: 输入联系方式(可选)

User -> Frontend: 提交反馈
Frontend -> APIGateway: 提交反馈
APIGateway -> FeedbackService: 处理反馈
FeedbackService -> FeedbackService: 验证反馈内容
alt 反馈内容为空
    FeedbackService --> APIGateway: 返回错误提示
    APIGateway --> Frontend: 返回错误提示
    Frontend -> User: 提示请填写反馈内容
else 反馈内容有效
    FeedbackService -> Database: 保存反馈记录
    Database --> FeedbackService: 保存成功
    
    alt 有上传截图
        FeedbackService -> ObjectStorage: 上传截图
        ObjectStorage --> FeedbackService: 上传成功
        FeedbackService -> Database: 更新反馈记录
        Database --> FeedbackService: 更新成功
    end
    
    FeedbackService -> Database: 更新反馈状态为"待处理"
    Database --> FeedbackService: 更新成功
    FeedbackService -> AsyncTaskQueue: 发送反馈通知
    AsyncTaskQueue -> FeedbackService: 通知发送成功
    
    FeedbackService --> APIGateway: 返回提交成功
    APIGateway --> Frontend: 返回提交成功
    Frontend -> User: 提示反馈提交成功
    Frontend -> User: 显示反馈ID
end

== 反馈处理流程 ==

FeedbackService -> Database: 查询待处理反馈
Database --> FeedbackService: 返回反馈列表

loop 遍历待处理反馈
    FeedbackService -> FeedbackService: 分析反馈内容
    FeedbackService -> FeedbackService: 分类反馈类型
    FeedbackService -> FeedbackService: 评估反馈优先级
    
    alt 高优先级反馈
        FeedbackService -> Database: 更新优先级为"高"
        Database --> FeedbackService: 更新成功
        FeedbackService -> AsyncTaskQueue: 发送紧急通知
        AsyncTaskQueue -> FeedbackService: 通知发送成功
    else 中优先级反馈
        FeedbackService -> Database: 更新优先级为"中"
        Database --> FeedbackService: 更新成功
    else 低优先级反馈
        FeedbackService -> Database: 更新优先级为"低"
        Database --> FeedbackService: 更新成功
    end
    
    FeedbackService -> Database: 更新反馈状态为"处理中"
    Database --> FeedbackService: 更新成功
    
    FeedbackService -> FeedbackService: 处理反馈
    alt 功能建议
        FeedbackService -> FeedbackService: 评估建议可行性
        FeedbackService -> Database: 记录评估结果
        Database --> FeedbackService: 记录成功
    else Bug反馈
        FeedbackService -> FeedbackService: 复现Bug
        FeedbackService -> FeedbackService: 定位问题
        FeedbackService -> FeedbackService: 修复Bug
        FeedbackService -> Database: 记录修复结果
        Database --> FeedbackService: 记录成功
    else 使用体验
        FeedbackService -> FeedbackService: 分析体验问题
        FeedbackService -> FeedbackService: 提出改进方案
        FeedbackService -> Database: 记录改进方案
        Database --> FeedbackService: 记录成功
    end
    
    FeedbackService -> Database: 更新反馈状态为"已处理"
    Database --> FeedbackService: 更新成功
    
    FeedbackService -> AsyncTaskQueue: 发送处理完成通知
    AsyncTaskQueue -> FeedbackService: 通知发送成功
end

== 反馈闭环流程 ==

FeedbackService -> Database: 查询已处理反馈
Database --> FeedbackService: 返回反馈列表

loop 遍历已处理反馈
    FeedbackService -> Database: 查询反馈详情
    Database --> FeedbackService: 返回反馈详情
    
    alt 需要用户确认
        FeedbackService -> AsyncTaskQueue: 发送确认通知
        AsyncTaskQueue -> FeedbackService: 通知发送成功
        
        User -> Frontend: 查看反馈状态
        Frontend -> APIGateway: 请求反馈状态
        APIGateway -> FeedbackService: 获取反馈状态
        FeedbackService -> Database: 查询反馈状态
        Database --> FeedbackService: 返回反馈状态
        FeedbackService --> APIGateway: 返回反馈状态
        APIGateway --> Frontend: 返回反馈状态
        Frontend -> User: 展示反馈状态
        
        User -> Frontend: 确认反馈处理
        Frontend -> APIGateway: 提交确认
        APIGateway -> FeedbackService: 更新反馈状态
        FeedbackService -> Database: 更新状态为"已确认"
        Database --> FeedbackService: 更新成功
        FeedbackService -> Database: 记录用户确认时间
        Database --> FeedbackService: 记录成功
    else 不需要用户确认
        FeedbackService -> Database: 更新状态为"已完成"
        Database --> FeedbackService: 更新成功
    end
end

== 反馈统计分析流程 ==

FeedbackService -> Database: 查询反馈统计数据
Database --> FeedbackService: 返回统计数据
FeedbackService -> FeedbackService: 生成反馈分析报告
FeedbackService -> FeedbackService: 分析反馈类型分布
FeedbackService -> FeedbackService: 分析反馈趋势
FeedbackService -> FeedbackService: 识别高频问题
FeedbackService -> Database: 保存分析报告
Database --> FeedbackService: 保存成功

FeedbackService -> Database: 查询用户满意度
Database --> FeedbackService: 返回满意度数据
FeedbackService -> FeedbackService: 计算满意度指标
FeedbackService -> Database: 保存满意度报告
Database --> FeedbackService: 保存成功

== 异常处理流程 ==

alt 数据删除失败
    UserService -> AsyncTaskQueue: 异步重试删除
    AsyncTaskQueue -> Database: 重试删除
    alt 重试成功
        AsyncTaskQueue -> UserService: 删除成功
    else 重试失败
        AsyncTaskQueue -> UserService: 删除失败
        UserService -> Database: 记录删除失败
        Database --> UserService: 记录成功
        UserService -> Frontend: 返回部分删除成功
        Frontend -> User: 提示部分数据删除失败
    end
end

alt 数据导出失败
    AsyncTaskQueue -> AsyncTaskQueue: 重试导出(最多3次)
    alt 重试成功
        AsyncTaskQueue -> APIGateway: 返回导出成功
    else 重试失败
        AsyncTaskQueue -> Database: 记录导出失败
        Database --> AsyncTaskQueue: 记录成功
        AsyncTaskQueue -> APIGateway: 返回导出失败
        APIGateway -> Frontend: 返回错误提示
        Frontend -> User: 提示导出失败，请稍后重试
    end
end

alt 反馈提交失败
    APIGateway -> APIGateway: 重试提交(最多3次)
    alt 重试成功
        APIGateway -> Frontend: 返回提交成功
    else 重试失败
        APIGateway -> Frontend: 返回错误提示
        Frontend -> User: 提示提交失败，请稍后重试
    end
end

@enduml
