@startuml AI心理医生MVP系统架构流程图_v2

skinparam backgroundColor #FEFEFE
skinparam handwritten false
skinparam shadowing false
skinparam defaultFontName "Microsoft YaHei"

title AI心理医生MVP系统架构流程图 (第二版)

' 定义样式
skinparam rectangle {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #0D47A1
}
skinparam database {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
    FontColor #E65100
}
skinparam cloud {
    BackgroundColor #F3E5F5
    BorderColor #7B1FA2
    FontColor #4A148C
}
skinparam agent {
    BackgroundColor #E8F5E9
    BorderColor #388E3C
    FontColor #1B5E20
}
skinparam queue {
    BackgroundColor #FFEBEE
    BorderColor #D32F2F
    FontColor #B71C1C
}

' 用户层
package "用户层" {
    rectangle "Web端应用\n(React + TypeScript)" as WebApp
    rectangle "移动端App\n(React Native)" as MobileApp
    rectangle "微信小程序" as MiniProgram
}

' 安全层
package "安全层" {
    rectangle "HTTPS加密\n(TLS 1.2+)" as HTTPS
    rectangle "JWT认证" as JWTAuth
    rectangle "API限流" as RateLimit
    rectangle "数据加密\n(AES-256)" as DataEncryption
}

' API网关层
package "API网关层" {
    rectangle "负载均衡" as LoadBalancer
    rectangle "API路由" as APIRouter
    rectangle "熔断器" as CircuitBreaker
    rectangle "日志监控" as LogMonitor
}

' 应用服务层
package "应用服务层" {
    rectangle "对话服务\n(ChatService)" as ChatService
    rectangle "情绪识别服务\n(EmotionService)" as EmotionService
    rectangle "评估服务\n(AssessmentService)" as AssessmentService
    rectangle "建议生成服务\n(SuggestionService)" as SuggestionService
    rectangle "预警服务\n(AlertService)" as AlertService
    rectangle "用户服务\n(UserService)" as UserService
    rectangle "通知服务\n(NotificationService)" as NotificationService
}

' 异步任务层
package "异步任务层" {
    queue "消息队列\n(Celery/Redis)" as MessageQueue
    rectangle "异步任务处理器" as AsyncTaskProcessor
}

' AI模型层
package "AI模型层" {
    cloud "对话模型\n(GPT/Claude)" as ChatModel
    cloud "情绪分析模型\n(BERT)" as EmotionModel
    cloud "推荐模型" as RecommendationModel
}

' 数据存储层
package "数据存储层" {
    database "PostgreSQL\n(用户数据、评估数据)" as PostgreSQL
    database "MongoDB\n(对话历史)" as MongoDB
    database "Redis\n(会话状态、缓存)" as Redis
    database "对象存储\n(用户文件、报告)" as ObjectStorage
    database "日志存储\n(Elasticsearch)" as LogStorage
}

' 备份与灾备层
package "备份与灾备层" {
    rectangle "数据备份\n(每日全量)" as DataBackup
    rectangle "增量备份\n(实时)" as IncrementalBackup
    rectangle "异地灾备" as DisasterRecovery
}

' 监控与告警层
package "监控与告警层" {
    rectangle "监控指标收集" as MetricsCollector
    rectangle "告警触发器" as AlertTrigger
    rectangle "故障自愈" as SelfHealing
}

' 外部服务层
package "外部服务层" {
    cloud "OpenAI API" as OpenAIAPI
    cloud "短信服务" as SMSService
    cloud "邮件服务" as EmailService
    cloud "第三方认证" as ThirdPartyAuth
}

' 连接关系
WebApp --> HTTPS
MobileApp --> HTTPS
MiniProgram --> HTTPS

HTTPS --> JWTAuth
JWTAuth --> RateLimit
RateLimit --> LoadBalancer

LoadBalancer --> APIRouter
APIRouter --> CircuitBreaker
CircuitBreaker --> LogMonitor

LogMonitor --> ChatService
LogMonitor --> AssessmentService
LogMonitor --> UserService

ChatService --> EmotionService
ChatService --> SuggestionService
ChatService --> AlertService
ChatService --> NotificationService

AssessmentService --> AlertService
AssessmentService --> SuggestionService

UserService --> ChatService
UserService --> AssessmentService

EmotionService --> EmotionModel
ChatService --> ChatModel
SuggestionService --> RecommendationModel

' 异步调用关系
ChatService --> MessageQueue
AlertService --> MessageQueue
AssessmentService --> MessageQueue
NotificationService --> MessageQueue

MessageQueue --> AsyncTaskProcessor
AsyncTaskProcessor --> SMSService
AsyncTaskProcessor --> EmailService

' 数据存储关系
ChatService --> MongoDB
ChatService --> Redis
AssessmentService --> PostgreSQL
AssessmentService --> MongoDB
UserService --> PostgreSQL
AlertService --> PostgreSQL
AlertService --> MongoDB
LogMonitor --> LogStorage

' 缓存策略
ChatService ..> Redis : 缓存会话状态
UserService ..> Redis : 缓存用户信息
AssessmentService ..> Redis : 缓存量表配置

' 备份关系
PostgreSQL --> DataBackup
MongoDB --> DataBackup
Redis --> DataBackup
ObjectStorage --> DataBackup

DataBackup --> IncrementalBackup
IncrementalBackup --> DisasterRecovery

' 监控关系
LoadBalancer --> MetricsCollector
ChatService --> MetricsCollector
PostgreSQL --> MetricsCollector
MongoDB --> MetricsCollector

MetricsCollector --> AlertTrigger
AlertTrigger --> SelfHealing

' 外部服务关系
ChatModel --> OpenAIAPI
NotificationService --> SMSService
NotificationService --> EmailService
JWTAuth --> ThirdPartyAuth

' 数据加密
PostgreSQL ..> DataEncryption : 敏感字段加密
MongoDB ..> DataEncryption : 对话内容加密
ObjectStorage ..> DataEncryption : 文件加密

note right of HTTPS
  - 强制HTTPS加密
  - TLS 1.2+协议
  - SSL证书验证
  - HSTS启用
end note

note right of JWTAuth
  - 用户身份认证
  - Token过期机制
  - 刷新Token策略
  - 多因素认证(MFA)
end note

note right of CircuitBreaker
  - 服务熔断保护
  - 自动降级策略
  - 失败重试机制
  - 超时控制
end note

note right of MessageQueue
  - 异步任务处理
  - 消息持久化
  - 死信队列
  - 任务重试机制
end note

note right of DataBackup
  - 每日全量备份
  - 实时增量备份
  - 异地灾备
  - 保留期3年
end note

note right of AlertTrigger
  - 实时监控指标
  - 异常告警
  - 自动通知
  - 故障自愈
end note

@enduml
