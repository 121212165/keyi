@startuml AI心理医生MVP系统架构流程图_v3

skinparam backgroundColor #FEFEFE
skinparam handwritten false
skinparam shadowing false
skinparam defaultFontName "Microsoft YaHei"

title AI心理医生MVP系统架构流程图 (第三版 - 最终定稿)

' 定义样式
skinparam rectangle {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #0D47A1
}
skinparam database {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
    FontColor #E65100
}
skinparam cloud {
    BackgroundColor #F3E5F5
    BorderColor #7B1FA2
    FontColor #4A148C
}
skinparam agent {
    BackgroundColor #E8F5E9
    BorderColor #388E3C
    FontColor #1B5E20
}
skinparam queue {
    BackgroundColor #FFEBEE
    BorderColor #D32F2F
    FontColor #B71C1C
}
skinparam storage {
    BackgroundColor #E0F7FA
    BorderColor #0097A7
    FontColor #006064
}

' 图例说明
legend right
|<#1976D2> 应用组件 | 实线箭头表示直接调用 |
|<#F57C00> 数据库组件 | 虚线箭头表示缓存关系 |
|<#7B1FA2> AI模型组件 | 点线箭头表示异步调用 |
|<#388E3C> 外部服务组件 | 粗线箭头表示数据流 |
|<#D32F2F> 消息队列组件 | |
|<#0097A7> 存储组件 | |
endlegend

' 用户层
package "用户层" {
    rectangle "Web端应用\n(React + TypeScript)" as WebApp
    rectangle "移动端App\n(React Native)" as MobileApp
    rectangle "微信小程序" as MiniProgram
}

' CDN层
package "CDN层" {
    storage "CDN节点\n(静态资源加速)" as CDN
    rectangle "静态资源缓存\n(Cache-Control)" as StaticCache
}

' 安全层
package "安全层" {
    rectangle "HTTPS加密\n(TLS 1.2+)" as HTTPS
    rectangle "JWT认证" as JWTAuth
    rectangle "API限流\n(Redis限流)" as RateLimit
    rectangle "数据加密\n(AES-256)" as DataEncryption
}

' API网关层
package "API网关层" {
    rectangle "负载均衡\n(Nginx)" as LoadBalancer
    rectangle "API路由" as APIRouter
    rectangle "熔断器\n(Hystrix)" as CircuitBreaker
    rectangle "日志监控" as LogMonitor
}

' 应用服务层
package "应用服务层" {
    rectangle "对话服务\n(ChatService)" as ChatService
    rectangle "情绪识别服务\n(EmotionService)" as EmotionService
    rectangle "评估服务\n(AssessmentService)" as AssessmentService
    rectangle "建议生成服务\n(SuggestionService)" as SuggestionService
    rectangle "预警服务\n(AlertService)" as AlertService
    rectangle "用户服务\n(UserService)" as UserService
    rectangle "通知服务\n(NotificationService)" as NotificationService
    rectangle "反馈服务\n(FeedbackService)" as FeedbackService
}

' 异步任务层
package "异步任务层" {
    queue "消息队列\n(Celery/Redis)" as MessageQueue
    rectangle "异步任务处理器" as AsyncTaskProcessor
}

' AI模型层
package "AI模型层" {
    cloud "对话模型\n(GPT/Claude)" as ChatModel
    cloud "情绪分析模型\n(BERT)" as EmotionModel
    cloud "推荐模型" as RecommendationModel
}

' 数据存储层
package "数据存储层" {
    database "PostgreSQL主库\n(用户数据、评估数据)" as PostgreSQL_Master
    database "PostgreSQL从库\n(只读查询)" as PostgreSQL_Slave
    database "MongoDB\n(对话历史)" as MongoDB
    database "Redis\n(会话状态、缓存)" as Redis
    database "对象存储\n(用户文件、报告)" as ObjectStorage
    database "日志存储\n(Elasticsearch)" as LogStorage
}

' 备份与灾备层
package "备份与灾备层" {
    rectangle "数据备份\n(每日全量)" as DataBackup
    rectangle "增量备份\n(实时)" as IncrementalBackup
    rectangle "异地灾备\n(异地机房)" as DisasterRecovery
}

' 监控与告警层
package "监控与告警层" {
    rectangle "监控指标收集\n(Prometheus)" as MetricsCollector
    rectangle "告警触发器\n(AlertManager)" as AlertTrigger
    rectangle "故障自愈" as SelfHealing
}

' 外部服务层
package "外部服务层" {
    cloud "OpenAI API" as OpenAIAPI
    cloud "短信服务\n(阿里云)" as SMSService
    cloud "邮件服务\n(SendGrid)" as EmailService
    cloud "第三方认证\n(Auth0)" as ThirdPartyAuth
}

' 连接关系
WebApp --> CDN
MobileApp --> CDN
MiniProgram --> CDN

CDN --> StaticCache
StaticCache --> HTTPS

HTTPS --> JWTAuth
JWTAuth --> RateLimit
RateLimit --> LoadBalancer

LoadBalancer --> APIRouter
APIRouter --> CircuitBreaker
CircuitBreaker --> LogMonitor

LogMonitor --> ChatService
LogMonitor --> AssessmentService
LogMonitor --> UserService
LogMonitor --> FeedbackService

ChatService --> EmotionService
ChatService --> SuggestionService
ChatService --> AlertService
ChatService --> NotificationService

AssessmentService --> AlertService
AssessmentService --> SuggestionService

UserService --> ChatService
UserService --> AssessmentService
UserService --> FeedbackService

FeedbackService -> UserService: 用户反馈处理

EmotionService --> EmotionModel
ChatService --> ChatModel
SuggestionService --> RecommendationModel

' 异步调用关系
ChatService ..> MessageQueue : 异步调用
AlertService ..> MessageQueue : 异步调用
AssessmentService ..> MessageQueue : 异步调用
NotificationService ..> MessageQueue : 异步调用
FeedbackService ..> MessageQueue : 异步调用

MessageQueue --> AsyncTaskProcessor
AsyncTaskProcessor --> SMSService
AsyncTaskProcessor --> EmailService

' 数据存储关系
ChatService --> MongoDB
ChatService --> Redis
AssessmentService --> PostgreSQL_Master
AssessmentService --> MongoDB
UserService --> PostgreSQL_Master
UserService --> PostgreSQL_Slave
AlertService --> PostgreSQL_Master
AlertService --> MongoDB
LogMonitor --> LogStorage

' 缓存策略
ChatService ..> Redis : 缓存会话状态\n(TTL: 30分钟)
UserService ..> Redis : 缓存用户信息\n(TTL: 1小时)
AssessmentService ..> Redis : 缓存量表配置\n(TTL: 24小时)
RateLimit ..> Redis : 限流计数器\n(TTL: 1分钟)

' 数据加密
PostgreSQL_Master ..> DataEncryption : 敏感字段加密
MongoDB ..> DataEncryption : 对话内容加密
ObjectStorage ..> DataEncryption : 文件加密

' 备份关系
PostgreSQL_Master ==> DataBackup : 每日全量备份
MongoDB ==> DataBackup : 每日全量备份
Redis ==> DataBackup : 每日全量备份
ObjectStorage ==> DataBackup : 每日全量备份

DataBackup ==> IncrementalBackup : 实时增量备份
IncrementalBackup ==> DisasterRecovery : 异地灾备

' 监控关系
LoadBalancer ==> MetricsCollector : 监控指标
ChatService ==> MetricsCollector : 监控指标
PostgreSQL_Master ==> MetricsCollector : 监控指标
MongoDB ==> MetricsCollector : 监控指标

MetricsCollector ==> AlertTrigger : 告警触发
AlertTrigger ==> SelfHealing : 故障自愈

' 外部服务关系
ChatModel ==> OpenAIAPI : API调用
NotificationService ==> SMSService : 短信发送
NotificationService ==> EmailService : 邮件发送
JWTAuth ==> ThirdPartyAuth : 第三方认证

note right of HTTPS
  - 强制HTTPS加密
  - TLS 1.2+协议
  - SSL证书验证
  - HSTS启用
end note

note right of JWTAuth
  - 用户身份认证
  - Token过期机制(24小时)
  - 刷新Token策略
  - 多因素认证(MFA)
end note

note right of RateLimit
  - 基于Redis限流
  - 用户级别限流
  - IP级别限流
  - 超限返回429
end note

note right of CircuitBreaker
  - 服务熔断保护
  - 自动降级策略
  - 失败重试(3次)
  - 超时控制(5秒)
end note

note right of MessageQueue
  - 异步任务处理
  - 消息持久化
  - 死信队列
  - 任务重试机制(最多5次)
  - 任务优先级(高/中/低)
end note

note right of DataBackup
  - 每日全量备份
  - 实时增量备份
  - 异地灾备
  - 保留期3年
  - 备份加密
end note

note right of AlertTrigger
  - 实时监控指标
  - 异常告警
  - 自动通知
  - 故障自愈
end note

note right of FeedbackService
  - 用户反馈收集
  - 反馈分类处理
  - 反馈统计分析
  - 反馈闭环管理
end note

note right of PostgreSQL_Master/PostgreSQL_Slave
  - 读写分离架构
  - 主库负责写操作
  - 从库负责读操作
  - 主从同步延迟<1秒
end note

note right of CDN
  - 静态资源加速
  - 全球节点分布
  - 智能路由
  - 缓存策略
end note

@enduml
