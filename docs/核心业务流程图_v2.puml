@startuml AI心理医生MVP核心业务流程图_v2

skinparam backgroundColor #FEFEFE
skinparam handwritten false
skinparam shadowing false
skinparam defaultFontName "Microsoft YaHei"

title AI心理医生MVP核心业务流程图 (第二版)

' 定义样式
skinparam participant {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #0D47A1
}
skinparam actor {
    BackgroundColor #E8F5E9
    BorderColor #388E3C
    FontColor #1B5E20
}
skinparam database {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
    FontColor #E65100
}

actor "用户" as User
participant "前端界面" as Frontend
participant "安全层\n(HTTPS/JWT)" as Security
participant "API网关\n(限流/熔断)" as APIGateway
participant "对话服务" as ChatService
participant "情绪识别服务" as EmotionService
participant "建议生成服务" as SuggestionService
participant "预警服务" as AlertService
participant "评估服务" as AssessmentService
participant "用户服务" as UserService
participant "通知服务" as NotificationService
participant "异步任务队列" as AsyncTaskQueue
database "数据库" as Database
database "缓存\n(Redis)" as Cache

== 用户注册与认证流程 ==

User -> Frontend: 打开应用
Frontend -> User: 展示欢迎页面和免责声明
User -> Frontend: 同意协议
Frontend -> Security: 生成匿名ID请求
Security -> Security: 设备指纹生成
Security -> APIGateway: 创建用户请求
APIGateway -> UserService: 创建匿名用户
UserService -> Database: 保存用户信息
Database --> UserService: 保存成功
UserService --> APIGateway: 返回用户ID
APIGateway --> Security: 返回用户ID
Security -> Security: 生成JWT Token
Security --> Frontend: 返回Token和用户ID
Frontend -> Cache: 缓存用户会话
Frontend -> User: 进入主界面

alt Token过期
    Frontend -> Security: 刷新Token
    Security --> Frontend: 返回新Token
end

== 对话交互流程 ==

User -> Frontend: 输入消息
Frontend -> Security: 验证JWT Token
Security --> Frontend: 验证通过
Frontend -> APIGateway: 发送消息请求
APIGateway -> APIGateway: 检查限流
alt 超过限流阈值
    APIGateway --> Frontend: 返回限流错误
    Frontend -> User: 提示稍后再试
else 未超过限流
    APIGateway -> ChatService: 转发消息
    ChatService -> Cache: 检查会话状态
    alt 会话不存在
        ChatService -> Database: 创建新会话
        Database --> ChatService: 会话创建成功
        ChatService -> Cache: 缓存会话状态
    else 会话存在
        ChatService -> Cache: 获取会话历史
        Cache --> ChatService: 返回历史记录
    end
    
    ChatService -> AlertService: 先检查风险
    AlertService -> AlertService: 匹配高危关键词
    alt 检测到一级预警
        AlertService -> Database: 记录预警事件
        AlertService -> NotificationService: 触发紧急通知
        NotificationService -> AsyncTaskQueue: 发送短信/邮件
        AsyncTaskQueue -> NotificationService: 发送成功
        AlertService --> ChatService: 返回一级预警
        ChatService -> Frontend: 返回预警信息
        Frontend -> User: 展示紧急资源
        Frontend -> User: 推荐专业帮助
        ChatService -> Database: 保存对话记录
    else 检测到二级预警
        AlertService -> Database: 记录预警事件
        AlertService --> ChatService: 返回二级预警
        ChatService -> EmotionService: 分析情绪
        EmotionService -> EmotionService: 识别基本情绪
        EmotionService -> EmotionService: 识别复合情绪
        EmotionService -> EmotionService: 判断情绪强度
        alt 情绪识别失败
            EmotionService --> ChatService: 返回默认情绪
        else 情绪识别成功
            EmotionService --> ChatService: 返回情绪结果
        end
        
        ChatService -> SuggestionService: 生成建议
        SuggestionService -> SuggestionService: 匹配情绪类型
        SuggestionService -> SuggestionService: 匹配情绪强度
        SuggestionService --> ChatService: 返回建议列表
        
        ChatService -> ChatService: 生成共情回应
        ChatService -> Frontend: 返回响应(含预警)
        Frontend -> User: 插入预警提示
        Frontend -> User: 展示AI回应
        ChatService -> Database: 保存对话记录
        ChatService -> Cache: 更新会话状态
    else 检测到三级预警
        AlertService -> Database: 记录预警事件
        AlertService --> ChatService: 返回三级预警
        ChatService -> EmotionService: 分析情绪
        EmotionService --> ChatService: 返回情绪结果
        
        ChatService -> SuggestionService: 生成建议
        SuggestionService --> ChatService: 返回建议列表
        
        ChatService -> ChatService: 生成共情回应
        ChatService -> Frontend: 返回响应
        Frontend -> User: 展示AI回应
        ChatService -> Database: 保存对话记录
        ChatService -> Cache: 更新会话状态
    else 无风险
        ChatService -> EmotionService: 分析情绪
        EmotionService --> ChatService: 返回情绪结果
        
        ChatService -> SuggestionService: 生成建议
        SuggestionService --> ChatService: 返回建议列表
        
        ChatService -> ChatService: 生成共情回应
        ChatService -> Frontend: 返回响应
        Frontend -> User: 展示AI回应
        ChatService -> Database: 保存对话记录
        ChatService -> Cache: 更新会话状态
    end
    
    alt API调用失败
        ChatService -> ChatService: 重试机制
        alt 重试成功
            ChatService -> Frontend: 返回响应
        else 重试失败
            ChatService -> Frontend: 返回错误提示
            Frontend -> User: 提示稍后重试
        end
    end
end

alt 会话超时
    ChatService -> Database: 结束会话
    ChatService -> Cache: 清除会话缓存
    Frontend -> User: 提示会话已结束
end

== 心理评估流程 ==

User -> Frontend: 选择评估类型
Frontend -> APIGateway: 请求量表
APIGateway -> AssessmentService: 获取量表
AssessmentService -> Cache: 检查量表缓存
alt 缓存命中
    Cache --> AssessmentService: 返回量表
else 缓存未命中
    AssessmentService -> Database: 查询量表配置
    Database --> AssessmentService: 返回量表
    AssessmentService -> Cache: 缓存量表配置
end
AssessmentService --> APIGateway: 返回量表
APIGateway --> Frontend: 返回量表
Frontend -> User: 展示评估说明

User -> Frontend: 逐题作答
Frontend -> Frontend: 显示进度条
User -> Frontend: 完成所有题目
Frontend -> APIGateway: 提交答案
APIGateway -> AssessmentService: 提交评估
AssessmentService -> UserService: 检查评估频率
UserService -> Database: 查询评估历史
Database --> UserService: 返回评估记录
UserService --> AssessmentService: 返回频率检查结果
alt 超过频率限制
    AssessmentService --> Frontend: 返回频率超限提示
    Frontend -> User: 提示每周只能评估一次
else 未超过频率限制
    AssessmentService -> AssessmentService: 计算得分
    AssessmentService -> AssessmentService: 确定等级
    alt 评估结果异常
        AssessmentService -> AlertService: 检查风险
        AlertService --> AssessmentService: 返回预警级别
        AssessmentService -> NotificationService: 发送通知
        NotificationService -> AsyncTaskQueue: 异步发送
    end
    
    AssessmentService -> Database: 保存评估结果
    Database --> AssessmentService: 保存成功
    AssessmentService -> SuggestionService: 生成建议
    SuggestionService --> AssessmentService: 返回建议
    AssessmentService -> AssessmentService: 生成评估报告
    AssessmentService -> Database: 保存报告
    AssessmentService --> APIGateway: 返回评估报告
    APIGateway --> Frontend: 返回报告
    Frontend -> User: 展示结果和建议
end

alt 评估中途退出
    Frontend -> AssessmentService: 保存草稿
    AssessmentService -> Database: 保存草稿
    Frontend -> User: 提示可继续完成
end

== 预警触发与处理流程 ==

ChatService -> AlertService: 实时监控
AlertService -> AlertService: 检测风险信号
AlertService -> AlertService: 判断预警级别

alt 一级预警(紧急)
    AlertService -> Database: 记录预警事件
    AlertService -> NotificationService: 触发紧急通知
    NotificationService -> AsyncTaskQueue: 发送短信/邮件
    AsyncTaskQueue -> NotificationService: 发送成功
    AlertService -> Frontend: 立即中断对话
    Frontend -> User: 展示紧急资源
    Frontend -> User: 推荐专业帮助
    AlertService -> AlertService: 启动定期跟进
else 二级预警(高危)
    AlertService -> Database: 记录预警事件
    AlertService -> NotificationService: 发送通知
    NotificationService -> AsyncTaskQueue: 异步发送
    AlertService -> Frontend: 插入预警提示
    Frontend -> User: 提供危机热线
    Frontend -> User: 建议专业帮助
    AlertService -> AlertService: 启动定期跟进
else 三级预警(关注)
    AlertService -> Database: 记录预警事件
    AlertService -> Frontend: 对话结束后展示
    Frontend -> User: 提供心理支持
    Frontend -> User: 建议进行评估
    AlertService -> AlertService: 启动定期回访
end

alt 预警解除
    AlertService -> Database: 更新预警状态
    AlertService -> NotificationService: 发送解除通知
    NotificationService -> AsyncTaskQueue: 异步发送
end

alt 预警升级
    AlertService -> Database: 更新预警级别
    AlertService -> NotificationService: 发送升级通知
    NotificationService -> AsyncTaskQueue: 异步发送
end

== 数据管理流程 ==

User -> Frontend: 查看数据
Frontend -> APIGateway: 请求数据
APIGateway -> Database: 查询数据
Database --> APIGateway: 返回数据
APIGateway --> Frontend: 返回数据
Frontend -> User: 展示数据

User -> Frontend: 删除数据
Frontend -> User: 确认删除
Frontend -> APIGateway: 请求删除
APIGateway -> Database: 删除数据
Database --> APIGateway: 删除成功
APIGateway -> Cache: 清除相关缓存
Cache --> APIGateway: 清除成功
APIGateway --> Frontend: 返回结果
Frontend -> User: 提示删除成功

User -> Frontend: 导出数据
Frontend -> APIGateway: 请求导出
APIGateway -> AsyncTaskQueue: 创建导出任务
AsyncTaskQueue -> Database: 查询数据
Database --> AsyncTaskQueue: 返回数据
AsyncTaskQueue -> AsyncTaskQueue: 生成导出文件
AsyncTaskQueue -> NotificationService: 通知用户
NotificationService -> AsyncTaskQueue: 发送通知
AsyncTaskQueue -> Frontend: 生成下载链接
Frontend -> User: 展示下载链接

== 异常处理流程 ==

alt API调用失败
    APIGateway -> APIGateway: 检查熔断器状态
    alt 熔断器开启
        APIGateway -> Frontend: 返回降级响应
        Frontend -> User: 提示服务暂时不可用
    else 熔断器关闭
        APIGateway -> APIGateway: 重试请求
        alt 重试成功
            APIGateway -> Frontend: 返回正常响应
        else 重试失败
            APIGateway -> APIGateway: 触发熔断器
            APIGateway -> Frontend: 返回降级响应
            Frontend -> User: 提示服务暂时不可用
        end
    end
end

alt 数据库连接失败
    APIGateway -> APIGateway: 切换到备用数据库
    alt 备用数据库可用
        APIGateway -> Frontend: 返回正常响应
    else 备用数据库不可用
        APIGateway -> Frontend: 返回错误提示
        Frontend -> User: 提示稍后重试
    end
end

alt 网络超时
    APIGateway -> APIGateway: 重试请求
    alt 重试成功
        APIGateway -> Frontend: 返回正常响应
    else 重试失败
        APIGateway -> Frontend: 返回超时提示
        Frontend -> User: 提示网络超时
    end
end

== 跨设备数据同步流程 ==

User -> Frontend: 登录新设备
Frontend -> Security: 验证身份
Security -> UserService: 获取用户数据
UserService -> Database: 查询用户数据
Database --> UserService: 返回用户数据
UserService --> Security: 返回用户数据
Security --> Frontend: 返回用户数据
Frontend -> Cache: 同步数据到缓存
Frontend -> User: 展示同步数据

@enduml
