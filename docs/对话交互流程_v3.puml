@startuml AI心理医生MVP对话交互流程_v3

skinparam backgroundColor #FEFEFE
skinparam handwritten false
skinparam shadowing false
skinparam defaultFontName "Microsoft YaHei"

title AI心理医生MVP对话交互流程 (第三版)

skinparam participant {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #0D47A1
}
skinparam database {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
    FontColor #E65100
}

actor "用户" as User
participant "前端界面" as Frontend
participant "安全层" as Security
participant "API网关" as APIGateway
participant "对话服务" as ChatService
participant "情绪识别服务" as EmotionService
participant "建议生成服务" as SuggestionService
participant "预警服务" as AlertService
participant "通知服务" as NotificationService
participant "异步任务队列" as AsyncTaskQueue
database "数据库\n(MongoDB)" as Database
database "缓存\n(Redis)" as Cache

== 对话会话管理 ==

User -> Frontend: 进入对话界面
Frontend -> Security: 验证JWT Token
Security --> Frontend: 验证通过
Frontend -> APIGateway: 检查会话状态
APIGateway -> ChatService: 检查会话
ChatService -> Cache: 查询会话状态
alt 会话不存在
    ChatService -> Database: 创建新会话
    Database --> ChatService: 会话创建成功
    ChatService -> Cache: 缓存会话状态\n(TTL: 30分钟)
    ChatService -> Database: 记录会话开始
else 会话存在
    ChatService -> Cache: 获取会话历史
    Cache --> ChatService: 返回历史记录
    alt 会话超时(>30分钟)
        ChatService -> Database: 结束会话
        ChatService -> Cache: 清除会话缓存
        ChatService -> Database: 创建新会话
        ChatService -> Cache: 缓存新会话状态
    end
end
ChatService --> APIGateway: 返回会话信息
APIGateway --> Frontend: 返回会话信息
Frontend -> User: 展示对话界面

== 消息发送与处理流程 ==

User -> Frontend: 输入消息
Frontend -> APIGateway: 发送消息请求
APIGateway -> APIGateway: 检查限流
alt 超过限流阈值
    APIGateway --> Frontend: 返回限流错误(429)
    Frontend -> User: 提示发送过快
else 未超过限流
    APIGateway -> ChatService: 转发消息
    ChatService -> AlertService: 先检查风险
    AlertService -> AlertService: 匹配高危关键词
    AlertService -> AlertService: 匹配绝望关键词
    AlertService -> AlertService: 检查评估异常
    
    alt 检测到一级预警(紧急)
        AlertService -> Database: 记录预警事件
        AlertService -> NotificationService: 触发紧急通知
        NotificationService -> AsyncTaskQueue: 发送短信/邮件\n(优先级: 高)
        AsyncTaskQueue -> NotificationService: 发送成功
        AlertService --> ChatService: 返回一级预警
        ChatService -> Database: 保存对话记录
        ChatService -> Database: 更新会话风险标志
        ChatService -> Frontend: 返回预警信息
        Frontend -> User: 展示紧急资源
        Frontend -> User: 推荐专业帮助
    else 检测到二级预警(高危)
        AlertService -> Database: 记录预警事件
        AlertService -> NotificationService: 发送通知
        NotificationService -> AsyncTaskQueue: 发送通知\n(优先级: 中)
        AlertService --> ChatService: 返回二级预警
        ChatService -> EmotionService: 分析情绪
        EmotionService -> EmotionService: 识别基本情绪
        EmotionService -> EmotionService: 识别复合情绪
        EmotionService -> EmotionService: 判断情绪强度
        alt 情绪识别失败
            EmotionService --> ChatService: 返回默认情绪(中性)
        else 情绪识别成功
            EmotionService --> ChatService: 返回情绪结果
        end
        
        ChatService -> SuggestionService: 生成建议
        SuggestionService -> SuggestionService: 匹配情绪类型
        SuggestionService -> SuggestionService: 匹配情绪强度
        SuggestionService -> SuggestionService: 选择建议类型
        SuggestionService --> ChatService: 返回建议列表(最多3条)
        
        ChatService -> ChatService: 生成共情回应
        ChatService -> Database: 保存对话记录
        ChatService -> Cache: 更新会话状态
        ChatService -> Frontend: 返回响应(含预警)
        Frontend -> User: 插入预警提示
        Frontend -> User: 展示AI回应
    else 检测到三级预警(关注)
        AlertService -> Database: 记录预警事件
        AlertService --> ChatService: 返回三级预警
        ChatService -> EmotionService: 分析情绪
        EmotionService --> ChatService: 返回情绪结果
        
        ChatService -> SuggestionService: 生成建议
        SuggestionService --> ChatService: 返回建议列表
        
        ChatService -> ChatService: 生成共情回应
        ChatService -> Database: 保存对话记录
        ChatService -> Cache: 更新会话状态
        ChatService -> Frontend: 返回响应
        Frontend -> User: 展示AI回应
    else 无风险
        ChatService -> EmotionService: 分析情绪
        EmotionService --> ChatService: 返回情绪结果
        
        ChatService -> SuggestionService: 生成建议
        SuggestionService --> ChatService: 返回建议列表
        
        ChatService -> ChatService: 生成共情回应
        ChatService -> Database: 保存对话记录
        ChatService -> Cache: 更新会话状态
        ChatService -> Frontend: 返回响应
        Frontend -> User: 展示AI回应
    end
end

== 多轮对话上下文管理 ==

ChatService -> Cache: 获取对话历史
Cache --> ChatService: 返回历史记录
ChatService -> ChatService: 维护对话上下文\n(最多10轮)
ChatService -> ChatService: 生成个性化回应

== 异常处理流程 ==

alt API调用失败
    ChatService -> ChatService: 重试请求(最多3次)
    alt 重试成功
        ChatService -> Frontend: 返回正常响应
    else 重试失败
        ChatService -> Frontend: 返回错误提示
        Frontend -> User: 提示稍后重试
    end
end

alt 情绪识别超时(>1秒)
    EmotionService --> ChatService: 返回默认情绪
    ChatService -> ChatService: 使用默认情绪继续
end

alt AI模型响应超时(>3秒)
    ChatService -> ChatService: 使用预设回应
    ChatService -> Frontend: 返回预设回应
    Frontend -> User: 提示AI响应较慢
end

alt 数据库写入失败
    ChatService -> ChatService: 记录到本地日志
    ChatService -> Frontend: 返回响应
    Frontend -> User: 正常展示回应
    ChatService -> AsyncTaskQueue: 异步重试写入
end

== 会话结束流程 ==

User -> Frontend: 主动结束对话
Frontend -> APIGateway: 结束会话请求
APIGateway -> ChatService: 结束会话
ChatService -> Database: 更新会话结束时间
ChatService -> Database: 生成会话总结
ChatService -> Cache: 清除会话缓存
ChatService -> Database: 保存会话总结
ChatService --> APIGateway: 返回结束成功
APIGateway --> Frontend: 返回结束成功
Frontend -> User: 提示会话已结束
Frontend -> User: 展示会话总结

@enduml
